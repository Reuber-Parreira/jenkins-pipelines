/*
 * The pipeline uses ssh connection. Jenkins ssh key pair must be set.
 * Global environment variable needed
 * _EMAIL_DOMAIN (mandatoy email domain id on ssh key i.g.: '@email.com')
 * _GENDATASET_SERVER_USERNAME (windows server admin user)
 * _GENDATASET_REGULAR_USERNAME (windows server regular user)
 * _GENDATASET_SERVER_ADDRESS (windows server address)
 */

pipeline {
  agent any
  stages {
    stage('Getting user Public Key') {
      steps {
        script {
          def userInput = input (
            id: 'publicKey',
            message: 'Enter the content of your gen_dataset_key.pub file',
            ok: 'Validate Key',
            parameters: [string(name: 'sshPubKey')]
          )

          userInput = userInput.trim()

          if(!userInput.contains("${_EMAIL_DOMAIN}")) {
            error ("""Your ssh key pair must be generated with the ${_EMAIL_DOMAIN} email domain.
            \nTry generate it by running:\n\$ ssh-keygen -t rsa -b 4096 -C 'your_email${_EMAIL_DOMAIN}' -f ~/.ssh/gen_dataset_key
            """)
          }

          sh "echo ${userInput} > ./public_key"
          stash 'public_key'
        } // script
      } // steps
    } // stage

    stage('Validating GenDataSet server connection') {
      steps {
        sshagent(credentials: ['gendataset-ssh-key']) {
          sh './jenkins/manage_user_gendataset_server/ssh_conn_validation.sh'
        } // sshagent
      } // steps
    } // stage

    stage('Adding user to GenDataSet server') {
      steps {
        unstash 'public_key'
        sshagent(credentials: ['gendataset-ssh-key']) {
          sh '''
            _PUBLIC_KEY=$(cat ./public_key)

            _ADD_KEY_BATCH_COMMAND="echo ${_PUBLIC_KEY}>>C:\\Users\\\\${_GENDATASET_REGULAR_USERNAME}\\.ssh\\authorized_keys"

            ssh ${_GENDATASET_SERVER_USERNAME}@${_GENDATASET_SERVER_ADDRESS} "${_ADD_KEY_BATCH_COMMAND}"
          '''
        } // sshagent
      } // steps
    } // stage
  } // stages

  post {
    always {
      sh 'rm ./public_key'
    }
  }
} // pipeline
